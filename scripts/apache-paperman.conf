# Apache reverse proxy configuration for Paperman Search Server
# Place in: /etc/apache2/sites-available/paperman.conf
# Enable with: sudo a2ensite paperman

<VirtualHost *:80>
    ServerName your-server.example.com

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName your-server.example.com

    # SSL Configuration
    SSLEngine on

    # For Let's Encrypt:
    # SSLCertificateFile /etc/letsencrypt/live/your-server.example.com/fullchain.pem
    # SSLCertificateKeyFile /etc/letsencrypt/live/your-server.example.com/privkey.pem

    # For self-signed (development):
    SSLCertificateFile /etc/ssl/certs/paperman.crt
    SSLCertificateKeyFile /etc/ssl/private/paperman.key

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite HIGH:!aNULL:!MD5
    SSLHonorCipherOrder on

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/paperman-error.log
    CustomLog ${APACHE_LOG_DIR}/paperman-access.log combined

    # Reverse proxy to paperman-server
    ProxyPreserveHost On
    ProxyRequests Off

    # Timeouts for PDF conversion
    ProxyTimeout 60

    # Proxy all requests to paperman-server
    ProxyPass / http://localhost:8080/
    ProxyPassReverse / http://localhost:8080/

    # Pass through headers including API key
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-For "%{REMOTE_ADDR}s"

    # Enable WebSocket support (if needed in future)
    # RewriteEngine On
    # RewriteCond %{HTTP:Upgrade} websocket [NC]
    # RewriteCond %{HTTP:Connection} upgrade [NC]
    # RewriteRule ^/?(.*) "ws://localhost:8080/$1" [P,L]
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
