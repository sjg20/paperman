name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  qt:
    name: Qt desktop app + server + C++ tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt5/C++ dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential \
            qt5-qmake qtbase5-dev qtbase5-dev-tools libqt5sql5-sqlite \
            libpoppler-qt5-dev libpodofo-dev \
            libtiff-dev libsane-dev libjpeg-dev zlib1g-dev \
            imagemagick tesseract-ocr tesseract-ocr-eng \
            python3-reportlab python3-pil python3-numpy \
            poppler-utils

      - name: Build desktop app
        run: qmake paperman.pro && make -f Makefile -j$(nproc)

      - name: Build server
        run: |
          qmake paperman-server.pro -o Makefile.server
          echo '#define SERVER_BUILD_DATE "CI"' > builddate.h
          make -f Makefile.server -j$(nproc)

      - name: Generate test data
        run: python3 scripts/make_test_files.py

      - name: Run Qt unit tests
        run: QT_QPA_PLATFORM=offscreen ./paperman -t

      - name: Run page-fetch integration test
        run: scripts/test_page_fetch.sh

      - name: Run parallel conversion test
        run: scripts/test_parallel.sh

  flutter:
    name: Flutter app + widget tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.41.1'
          channel: stable

      - name: Generate demo assets
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3-reportlab python3-pil python3-numpy poppler-utils
          python3 app/tools/gen_demo_assets.py

      - name: Analyse
        run: cd app && flutter analyze

      - name: Run widget tests
        run: cd app && flutter test

      - name: Set up dart-defines
        run: |
          APP_VERSION=$(sed -n 's/.*CONFIG_version_str "\(.*\)"/\1.0/p' config.h)
          echo "APP_VERSION=$APP_VERSION" >> "$GITHUB_ENV"
          echo "{\"BUILD_DATE\":\"$(date '+%a %d %b %H:%M:%S %Z %Y')\"}" > app/dart-defines.json

      - name: Build release APK
        run: |
          cd app && flutter build apk \
            --build-name="$APP_VERSION" \
            --dart-define-from-file=dart-defines.json

      - name: Install Linux desktop dependencies
        run: |
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config \
            libgtk-3-dev liblzma-dev libstdc++-12-dev

      - name: Build Linux desktop app
        run: |
          cd app && flutter build linux \
            --build-name="$APP_VERSION" \
            --dart-define-from-file=dart-defines.json

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: paperman-apk
          path: app/build/app/outputs/flutter-apk/app-release.apk

  docs:
    name: Sphinx documentation
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: doc/requirements.txt

      - name: Install Sphinx
        run: pip install -r doc/requirements.txt

      - name: Build docs
        run: sphinx-build -b html doc doc/_build/html
